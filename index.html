<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mkomani Clinic CBS Dashboard</title>
    <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
    <script src="https://unpkg.com/xlsx/dist/xlsx.full.min.js"></script>
    <style>
        :root {
            --primary: #2c3e50;
            --secondary: #3498db;
            --success: #27ae60;
            --warning: #f39c12;
            --danger: #e74c3c;
            --light: #ecf0f1;
            --dark: #34495e;
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
        }
        
        /* Header Styles */
        .header {
            background: white;
            border-radius: 15px;
            padding: 25px;
            margin-bottom: 25px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            border-left: 5px solid var(--secondary);
        }
        
        .header h1 {
            color: var(--primary);
            font-size: 28px;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 15px;
        }
        
        .period {
            background: var(--light);
            padding: 8px 15px;
            border-radius: 20px;
            font-weight: 600;
            color: var(--dark);
            display: inline-block;
            margin-bottom: 15px;
        }
        
        /* File Upload Section */
        .upload-section {
            background: white;
            border-radius: 15px;
            padding: 25px;
            margin-bottom: 25px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
        }
        
        .upload-title {
            color: var(--primary);
            font-size: 20px;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .upload-box {
            border: 2px dashed var(--secondary);
            border-radius: 10px;
            padding: 30px;
            text-align: center;
            margin-bottom: 20px;
            background: rgba(52, 152, 219, 0.05);
        }
        
        .file-input {
            display: none;
        }
        
        .file-label {
            background: linear-gradient(135deg, var(--secondary), #2980b9);
            color: white;
            padding: 15px 30px;
            border-radius: 10px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            display: inline-flex;
            align-items: center;
            gap: 10px;
            transition: all 0.3s ease;
        }
        
        .file-label:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(52, 152, 219, 0.4);
        }
        
        .file-list {
            margin-top: 20px;
        }
        
        .file-item {
            background: var(--light);
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        /* Action Buttons */
        .action-buttons {
            display: flex;
            gap: 15px;
            margin-top: 20px;
        }
        
        .btn {
            padding: 15px 30px;
            border-radius: 10px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            border: none;
            display: flex;
            align-items: center;
            gap: 10px;
            transition: all 0.3s ease;
        }
        
        .btn-primary {
            background: linear-gradient(135deg, var(--secondary), #2980b9);
            color: white;
        }
        
        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(52, 152, 219, 0.4);
        }
        
        .btn-success {
            background: linear-gradient(135deg, var(--success), #229954);
            color: white;
        }
        
        .btn-success:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(39, 174, 96, 0.4);
        }
        
        /* Dashboard Sections */
        .dashboard-section {
            display: none;
        }
        
        .dashboard-section.active {
            display: block;
        }
        
        /* KPI Grid */
        .kpi-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .kpi-card {
            background: white;
            border-radius: 15px;
            padding: 25px;
            text-align: center;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            position: relative;
            overflow: hidden;
        }
        
        .kpi-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 5px;
        }
        
        .kpi-card:nth-child(1)::before { background: var(--success); }
        .kpi-card:nth-child(2)::before { background: var(--secondary); }
        .kpi-card:nth-child(3)::before { background: var(--warning); }
        .kpi-card:nth-child(4)::before { background: var(--danger); }
        
        .kpi-value {
            font-size: 42px;
            font-weight: 700;
            margin: 15px 0;
            font-family: 'Arial', sans-serif;
        }
        
        .kpi-label {
            color: var(--dark);
            font-size: 14px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 1px;
        }
        
        .kpi-subtext {
            color: #7f8c8d;
            font-size: 13px;
            margin-top: 10px;
        }
        
        /* CARDS - FIXED FOR FULL WIDTH */
        .card {
            background: white;
            border-radius: 15px;
            padding: 25px;
            margin-bottom: 25px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            width: 100% !important;
            display: block !important;
        }
        
        .full-width-card {
            width: 100% !important;
            max-width: 100% !important;
            margin-left: 0 !important;
            margin-right: 0 !important;
        }
        
        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid var(--light);
        }
        
        .card-title {
            color: var(--primary);
            font-size: 20px;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        /* Chart Containers - FULL WIDTH */
        .chart-container {
            height: 500px;
            width: 100% !important;
            margin-top: 15px;
        }
        
        .gap-chart-container {
            height: 350px;
            width: 100% !important;
            margin-top: 15px;
        }
        
        /* Gap Analysis Grid */
        .gap-analysis-grid {
            display: grid;
            grid-template-columns: 1fr;
            gap: 25px;
            margin-top: 20px;
            width: 100% !important;
        }
        
        .other-gaps-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(500px, 1fr));
            gap: 20px;
            margin-top: 30px;
            width: 100% !important;
        }
        
        .gap-indicator-card {
            background: white;
            border-radius: 10px;
            padding: 20px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            border-left: 4px solid var(--secondary);
            width: 100% !important;
        }
        
        .gap-indicator-title {
            font-weight: 600;
            color: var(--primary);
            margin-bottom: 15px;
            font-size: 16px;
            height: 50px;
        }
        
        /* Discussion Canvas */
        .discussion-canvas {
            width: 100% !important;
        }
        
        .recommendation-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }
        
        .recommendation-card {
            background: white;
            border-radius: 10px;
            padding: 20px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            border-top: 4px solid;
        }
        
        .recommendation-card.reporting {
            border-top-color: var(--secondary);
        }
        
        .recommendation-card.consistency {
            border-top-color: var(--success);
        }
        
        .recommendation-card.mitigation {
            border-top-color: var(--warning);
        }
        
        .recommendation-title {
            font-weight: 600;
            color: var(--primary);
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        /* Alert */
        .alert {
            padding: 15px;
            border-radius: 10px;
            margin: 15px 0;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .alert-danger {
            background: rgba(231, 76, 60, 0.1);
            color: var(--danger);
            border: 1px solid rgba(231, 76, 60, 0.2);
        }
        
        .alert-success {
            background: rgba(39, 174, 96, 0.1);
            color: var(--success);
            border: 1px solid rgba(39, 174, 96, 0.2);
        }
        
        /* Loader */
        .loader {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(255,255,255,0.9);
            z-index: 1000;
            justify-content: center;
            align-items: center;
            flex-direction: column;
            gap: 20px;
        }
        
        .loader.active {
            display: flex;
        }
        
        .spinner {
            width: 50px;
            height: 50px;
            border: 5px solid var(--light);
            border-top: 5px solid var(--secondary);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        /* Footer */
        .footer {
            text-align: center;
            color: white;
            margin-top: 40px;
            padding: 20px;
            opacity: 0.8;
        }
        
        /* Responsive */
        @media (max-width: 768px) {
            .header h1 {
                font-size: 24px;
            }
            
            .kpi-grid {
                grid-template-columns: 1fr;
            }
            
            .action-buttons {
                flex-direction: column;
            }
            
            .btn {
                width: 100%;
                justify-content: center;
            }
            
            .chart-container {
                height: 400px;
            }
            
            .other-gaps-grid {
                grid-template-columns: 1fr;
            }
            
            .card {
                padding: 15px;
            }
        }
    </style>
</head>
<body>
    <div class="loader" id="loader">
        <div class="spinner"></div>
        <div class="loader-text" id="loaderText">Loading Dashboard...</div>
    </div>
    
    <div class="container">
        <!-- Header -->
        <div class="header">
            <h1>
                üìä Mkomani Clinic Society Weekly CBS Bulletin
            </h1>
            <div class="period" id="periodDisplay">Period: 24th - 28th Nov 2025</div>
            <p>Interactive dashboard with actual CBS data for all sites</p>
        </div>
        
        <!-- Quick Start Section -->
        <div class="card" id="quickStartSection">
            <div class="card-header">
                <div class="card-title">
                    üöÄ Dashboard Ready to View
                </div>
            </div>
            <div style="padding: 20px; text-align: center;">
                <div style="background: rgba(39, 174, 96, 0.1); padding: 30px; border-radius: 10px; margin-bottom: 20px;">
                    <h3 style="color: var(--success); margin-bottom: 15px;">üìä Real Data Loaded</h3>
                    <p style="color: var(--dark); margin-bottom: 20px; line-height: 1.6;">
                        The dashboard contains actual CBS data for all 14 sites.<br>
                        Click below to view the complete analysis with real metrics.
                    </p>
                    <button class="btn btn-success" onclick="loadRealData()" style="width: 100%; max-width: 300px; margin: 0 auto;">
                        üöÄ Click here to View Dashboard
                    </button>
                </div>
                
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 15px; margin-top: 20px;">
                    <div style="background: rgba(52, 152, 219, 0.1); padding: 15px; border-radius: 10px;">
                        <div style="font-size: 24px; font-weight: bold; color: var(--secondary);">14</div>
                        <div style="color: var(--dark); font-size: 14px;">Active Sites</div>
                    </div>
                    <div style="background: rgba(243, 156, 18, 0.1); padding: 15px; border-radius: 10px;">
                        <div style="font-size: 24px; font-weight: bold; color: var(--warning);">589/644</div>
                        <div style="color: var(--dark); font-size: 14px;">Total Gaps</div>
                    </div>
                    <div style="background: rgba(46, 204, 113, 0.1); padding: 15px; border-radius: 10px;">
                        <div style="font-size: 24px; font-weight: bold; color: var(--success);">92.9%</div>
                        <div style="color: var(--dark); font-size: 14px;">Reporting Rate</div>
                    </div>
                </div>
                
                <div style="margin-top: 20px; padding: 15px; background: rgba(241, 196, 15, 0.1); border-radius: 10px;">
                    <p style="color: var(--dark); font-size: 14px;">
                        <strong>Note:</strong> This dashboard contains real CBS data. Address noted gaps from your facility as feasible.
                    </p>
                </div>
            </div>
        </div>
        
        <!-- File Upload Section -->
        <div class="upload-section" id="uploadSection" style="display: none;">
            <div class="upload-title">
                üìÅ Upload New Excel Files
            </div>
            
            <div class="alert alert-danger" id="errorAlert" style="display: none;">
                ‚ö†Ô∏è Please upload both Excel files to proceed.
            </div>
            
            <div class="alert alert-success" id="successAlert" style="display: none;">
                ‚úÖ Files uploaded successfully! Click "Generate Dashboard" to continue.
            </div>
            
            <div class="upload-box" id="uploadBox">
                <p style="margin-bottom: 20px; color: var(--dark);">
                    Drag and drop your Excel files here, or click to browse
                </p>
                <input type="file" id="fileInput" class="file-input" accept=".xlsx,.xls" multiple>
                <label for="fileInput" class="file-label">
                    üìÇ Choose Excel Files
                </label>
                <p style="margin-top: 15px; color: #7f8c8d; font-size: 14px;">
                    Required files: weekly_Gap_data_Site.xlsx and weekly_RR_data_Site.xlsx
                </p>
            </div>
            
            <div class="file-list" id="fileList">
                <!-- File items will be added here -->
            </div>
            
            <div class="action-buttons">
                <button class="btn btn-primary" onclick="processUploadedFiles()" id="generateBtn" disabled>
                    üöÄ Generate Dashboard
                </button>
                <button class="btn" onclick="showDashboard()" style="background: var(--light); color: var(--dark);">
                    ‚Ü©Ô∏è Back to Dashboard
                </button>
            </div>
        </div>
        
        <!-- Dashboard Section -->
        <div class="dashboard-section" id="dashboardSection" style="display: none;">
            <!-- KPI Overview -->
            <div class="kpi-grid" id="kpiSection"></div>
            
            <!-- Reporting Rate Chart -->
            <div class="card full-width-card">
                <div class="card-header">
                    <div class="card-title">üìà Reporting Rate by Site (Descending Order)</div>
                </div>
                <div class="chart-container" id="reportingRateChart"></div>
            </div>
            
            <!-- Consistency Rate Chart -->
            <div class="card full-width-card">
                <div class="card-header">
                    <div class="card-title">üìä Consistency Rate by Site (Descending Order)</div>
                </div>
                <div class="chart-container" id="consistencyChart"></div>
            </div>
            
            <!-- Gap Distribution by Facility Chart -->
            <div class="card full-width-card">
                <div class="card-header">
                    <div class="card-title">üìä Gap Distribution by Facility (Ranked Highest to Lowest)</div>
                </div>
                <div class="chart-container" id="gapDistributionChart"></div>
            </div>
            
            <!-- Gap Analysis by Indicator -->
            <div class="card full-width-card">
                <div class="card-header">
                    <div class="card-title">üîç Gap Analysis by Indicator (Facilities Affected)</div>
                </div>
                <div id="delayedVLChartContainer" style="margin-bottom: 30px; width: 100%;"></div>
                <div class="other-gaps-grid" id="otherGapsGrid"></div>
            </div>
            
            <!-- Discussion Canvas -->
            <div class="card discussion-canvas">
                <div class="card-header">
                    <div class="card-title">üí¨ Discussion & Recommendations</div>
                </div>
                <div style="margin-bottom: 30px;">
                    <h3 style="color: var(--primary); margin-bottom: 15px;">üìã Gap Summary Analysis</h3>
                    <div id="gapSummary"></div>
                </div>
                <div>
                    <h3 style="color: var(--primary); margin-bottom: 15px;">üéØ Recommendations & Mitigation Strategies</h3>
                    <div class="recommendation-grid">
                        <div class="recommendation-card reporting">
                            <div class="recommendation-title">üìä For Reporting Rate Improvement:</div>
                            <ul style="padding-left: 20px; color: var(--dark); line-height: 1.6;">
                                <li><strong>Daily monitoring</strong> of reporting status at site level</li>
                                <li><strong>Designate reporting champions</strong> at each site</li>
                                <li>Implement <strong>automated reminders</strong> for reporting deadlines</li>
                                <li>Conduct <strong>weekly review meetings</strong> with site supervisors</li>
                            </ul>
                        </div>
                        <div class="recommendation-card consistency">
                            <div class="recommendation-title">‚úÖ For Gap Improvement:</div>
                            <ul style="padding-left: 20px; color: var(--dark); line-height: 1.6;">
                                <li><strong>Conduct weekly CBS meetings</strong> across all sites</li>
                                <li>Conduct <strong>root cause analysis (RCA)</strong> across all sites</li>
                                <li>Address <strong>gaps as actioned</strong> by responsible staff</li>
                                <li>Track <strong>Progress or new gaps on a daily basis</strong> proactive monitoring</li>
                            </ul>
                        </div>
                        <div class="recommendation-card mitigation">
                            <div class="recommendation-title">‚ö° Technical & Infrastructure:</div>
                            <ul style="padding-left: 20px; color: var(--dark); line-height: 1.6;">
                                <li>Address <strong>internet connectivity issues</strong> at affected sites</li>
                                <li>Ensure <strong>uninterrupted power supply</strong> during reporting hours</li>
                                <li>Set <strong>EMR schedulers</strong> to run during off-peak hours</li>
                                <li>Implement <strong>offline data collection</strong> with sync capability</li>
                            </ul>
                        </div>
                    </div>
                </div>
                <div style="margin-top: 30px; padding: 20px; background: rgba(52, 152, 219, 0.1); border-radius: 10px;">
                    <h4 style="color: var(--primary); margin-bottom: 10px;">üìÖ Immediate Action Plan:</h4>
                    <div style="color: var(--dark);">
                        <p><strong>This Week:</strong> M&E Manager to contact sites with reporting rate below 80% to identify challenges</p>
                        <p><strong>Next 2 Weeks:</strong> Remind staff to interact with the CBS dashboard on a daily basis</p>
                        <p><strong>Ongoing:</strong> Monitor progress weekly and adjust strategies as needed</p>
                    </div>
                </div>
            </div>
            
            <!-- Export Buttons -->
            <div style="text-align: center; margin-top: 30px;">
                <button class="btn btn-primary" onclick="printDashboard()">üñ®Ô∏è Print Dashboard</button>
                <button class="btn btn-success" onclick="exportDataToCSV()">üìä Export Data to CSV</button>
                <button class="btn" onclick="showUploadSection()" style="background: var(--secondary); color: white;">üìÅ Upload New Data</button>
                <button class="btn" onclick="loadRealData()" style="background: var(--light); color: var(--dark);">üîÑ Refresh Dashboard</button>
            </div>
        </div>
        
        <!-- Footer -->
        <div class="footer">
            <p>¬© 2025 Mkomani Clinic Society - Case Based Surveillance System</p>
            <p>Data updated automatically | Contact: cbs.support@mkomaniclinic.org</p>
        </div>
    </div>

    <script>
        // ======================
        // REAL DATA - EMBEDDED
        // ======================
        
        const REAL_DATA = {
            "metadata": {
                "generated": "2025-12-01 14:47:23",
                "period": "24th - 28th Nov 2025",
                "total_sites": 14,
                "data_source": "Weekly CBS Reports"
            },
            "gap_data": [
                {
                    "site": "Overall",
                    "indicators": [
                        {"indicator": "HIV +ve Clients Not Linked to ART", "gap": 9, "eligible": 16, "gap_percentage": 56.25},
                        {"indicator": "HIV Negative High-Risk Pregnant/Postpartum Women not Enrolled on PrEP", "gap": 7, "eligible": 7, "gap_percentage": 100.0},
                        {"indicator": "Virally Unsuppressed Clients Without EAC Within 2 Weeks", "gap": 0, "eligible": 0, "gap_percentage": 0.0},
                        {"indicator": "Delayed Viral Load Testing", "gap": 570, "eligible": 644, "gap_percentage": 88.50931677018633},
                        {"indicator": "HEI (6-8 Weeks) Without DNA PCR Results", "gap": 2, "eligible": 2, "gap_percentage": 100.0},
                        {"indicator": "HEI (24 Months) Without Final Documented Outcome", "gap": 1, "eligible": 9, "gap_percentage": 11.11111111111111}
                    ]
                },
                {
                    "site": "Bomu Alwalidayn",
                    "indicators": [
                        {"indicator": "HIV +ve Clients Not Linked to ART", "gap": 0, "eligible": 3, "gap_percentage": 0.0},
                        {"indicator": "HIV Negative High-Risk Pregnant/Postpartum Women not Enrolled on PrEP", "gap": 3, "eligible": 3, "gap_percentage": 100.0},
                        {"indicator": "Virally Unsuppressed Clients Without EAC Within 2 Weeks", "gap": 0, "eligible": 0, "gap_percentage": 0.0},
                        {"indicator": "Delayed Viral Load Testing", "gap": 33, "eligible": 38, "gap_percentage": 86.8421052631579},
                        {"indicator": "HEI (6-8 Weeks) Without DNA PCR Results", "gap": 0, "eligible": 0, "gap_percentage": 0.0},
                        {"indicator": "HEI (24 Months) Without Final Documented Outcome", "gap": 0, "eligible": 2, "gap_percentage": 0.0}
                    ]
                },
                {
                    "site": "Bomu Likoni",
                    "indicators": [
                        {"indicator": "HIV +ve Clients Not Linked to ART", "gap": 3, "eligible": 3, "gap_percentage": 100.0},
                        {"indicator": "HIV Negative High-Risk Pregnant/Postpartum Women not Enrolled on PrEP", "gap": 0, "eligible": 0, "gap_percentage": 0.0},
                        {"indicator": "Virally Unsuppressed Clients Without EAC Within 2 Weeks", "gap": 0, "eligible": 0, "gap_percentage": 0.0},
                        {"indicator": "Delayed Viral Load Testing", "gap": 159, "eligible": 170, "gap_percentage": 93.52941176470588},
                        {"indicator": "HEI (6-8 Weeks) Without DNA PCR Results", "gap": 1, "eligible": 1, "gap_percentage": 100.0},
                        {"indicator": "HEI (24 Months) Without Final Documented Outcome", "gap": 0, "eligible": 1, "gap_percentage": 0.0}
                    ]
                },
                {
                    "site": "Bomu Changamwe",
                    "indicators": [
                        {"indicator": "HIV +ve Clients Not Linked to ART", "gap": 2, "eligible": 2, "gap_percentage": 100.0},
                        {"indicator": "HIV Negative High-Risk Pregnant/Postpartum Women not Enrolled on PrEP", "gap": 1, "eligible": 1, "gap_percentage": 100.0},
                        {"indicator": "Virally Unsuppressed Clients Without EAC Within 2 Weeks", "gap": 0, "eligible": 0, "gap_percentage": 0.0},
                        {"indicator": "Delayed Viral Load Testing", "gap": 172, "eligible": 206, "gap_percentage": 83.49514563106796},
                        {"indicator": "HEI (6-8 Weeks) Without DNA PCR Results", "gap": 0, "eligible": 0, "gap_percentage": 0.0},
                        {"indicator": "HEI (24 Months) Without Final Documented Outcome", "gap": 1, "eligible": 3, "gap_percentage": 33.33333333333333}
                    ]
                },
                {
                    "site": "Bomu OldTown",
                    "indicators": [
                        {"indicator": "HIV +ve Clients Not Linked to ART", "gap": 0, "eligible": 0, "gap_percentage": 0.0},
                        {"indicator": "HIV Negative High-Risk Pregnant/Postpartum Women not Enrolled on PrEP", "gap": 0, "eligible": 0, "gap_percentage": 0.0},
                        {"indicator": "Virally Unsuppressed Clients Without EAC Within 2 Weeks", "gap": 0, "eligible": 0, "gap_percentage": 0.0},
                        {"indicator": "Delayed Viral Load Testing", "gap": 0, "eligible": 0, "gap_percentage": 0.0},
                        {"indicator": "HEI (6-8 Weeks) Without DNA PCR Results", "gap": 0, "eligible": 0, "gap_percentage": 0.0},
                        {"indicator": "HEI (24 Months) Without Final Documented Outcome", "gap": 0, "eligible": 0, "gap_percentage": 0.0}
                    ]
                },
                {
                    "site": "Bomu Bombolulu",
                    "indicators": [
                        {"indicator": "HIV +ve Clients Not Linked to ART", "gap": 0, "eligible": 0, "gap_percentage": 0.0},
                        {"indicator": "HIV Negative High-Risk Pregnant/Postpartum Women not Enrolled on PrEP", "gap": 0, "eligible": 0, "gap_percentage": 0.0},
                        {"indicator": "Virally Unsuppressed Clients Without EAC Within 2 Weeks", "gap": 0, "eligible": 0, "gap_percentage": 0.0},
                        {"indicator": "Delayed Viral Load Testing", "gap": 10, "eligible": 16, "gap_percentage": 62.5},
                        {"indicator": "HEI (6-8 Weeks) Without DNA PCR Results", "gap": 1, "eligible": 1, "gap_percentage": 100.0},
                        {"indicator": "HEI (24 Months) Without Final Documented Outcome", "gap": 0, "eligible": 2, "gap_percentage": 0.0}
                    ]
                },
                {
                    "site": "Bomu Mariakani",
                    "indicators": [
                        {"indicator": "HIV +ve Clients Not Linked to ART", "gap": 1, "eligible": 1, "gap_percentage": 100.0},
                        {"indicator": "HIV Negative High-Risk Pregnant/Postpartum Women not Enrolled on PrEP", "gap": 0, "eligible": 0, "gap_percentage": 0.0},
                        {"indicator": "Virally Unsuppressed Clients Without EAC Within 2 Weeks", "gap": 0, "eligible": 0, "gap_percentage": 0.0},
                        {"indicator": "Delayed Viral Load Testing", "gap": 93, "eligible": 95, "gap_percentage": 97.89473684210527},
                        {"indicator": "HEI (6-8 Weeks) Without DNA PCR Results", "gap": 0, "eligible": 0, "gap_percentage": 0.0},
                        {"indicator": "HEI (24 Months) Without Final Documented Outcome", "gap": 0, "eligible": 1, "gap_percentage": 0.0}
                    ]
                },
                {
                    "site": "Bomu Timboni",
                    "indicators": [
                        {"indicator": "HIV +ve Clients Not Linked to ART", "gap": 0, "eligible": 0, "gap_percentage": 0.0},
                        {"indicator": "HIV Negative High-Risk Pregnant/Postpartum Women not Enrolled on PrEP", "gap": 0, "eligible": 0, "gap_percentage": 0.0},
                        {"indicator": "Virally Unsuppressed Clients Without EAC Within 2 Weeks", "gap": 0, "eligible": 0, "gap_percentage": 0.0},
                        {"indicator": "Delayed Viral Load Testing", "gap": 26, "eligible": 28, "gap_percentage": 92.85714285714286},
                        {"indicator": "HEI (6-8 Weeks) Without DNA PCR Results", "gap": 0, "eligible": 0, "gap_percentage": 0.0},
                        {"indicator": "HEI (24 Months) Without Final Documented Outcome", "gap": 0, "eligible": 0, "gap_percentage": 0.0}
                    ]
                },
                {
                    "site": "CBHC Chaani",
                    "indicators": [
                        {"indicator": "HIV +ve Clients Not Linked to ART", "gap": 0, "eligible": 0, "gap_percentage": 0.0},
                        {"indicator": "HIV Negative High-Risk Pregnant/Postpartum Women not Enrolled on PrEP", "gap": 0, "eligible": 0, "gap_percentage": 0.0},
                        {"indicator": "Virally Unsuppressed Clients Without EAC Within 2 Weeks", "gap": 0, "eligible": 0, "gap_percentage": 0.0},
                        {"indicator": "Delayed Viral Load Testing", "gap": 3, "eligible": 5, "gap_percentage": 60.0},
                        {"indicator": "HEI (6-8 Weeks) Without DNA PCR Results", "gap": 0, "eligible": 0, "gap_percentage": 0.0},
                        {"indicator": "HEI (24 Months) Without Final Documented Outcome", "gap": 0, "eligible": 0, "gap_percentage": 0.0}
                    ]
                },
                {
                    "site": "CBHC Mbungoni",
                    "indicators": [
                        {"indicator": "HIV +ve Clients Not Linked to ART", "gap": 3, "eligible": 3, "gap_percentage": 100.0},
                        {"indicator": "HIV Negative High-Risk Pregnant/Postpartum Women not Enrolled on PrEP", "gap": 2, "eligible": 2, "gap_percentage": 100.0},
                        {"indicator": "Virally Unsuppressed Clients Without EAC Within 2 Weeks", "gap": 0, "eligible": 0, "gap_percentage": 0.0},
                        {"indicator": "Delayed Viral Load Testing", "gap": 19, "eligible": 24, "gap_percentage": 79.16666666666666},
                        {"indicator": "HEI (6-8 Weeks) Without DNA PCR Results", "gap": 0, "eligible": 0, "gap_percentage": 0.0},
                        {"indicator": "HEI (24 Months) Without Final Documented Outcome", "gap": 0, "eligible": 0, "gap_percentage": 0.0}
                    ]
                },
                {
                    "site": "CBHC Mikindani",
                    "indicators": [
                        {"indicator": "HIV +ve Clients Not Linked to ART", "gap": 0, "eligible": 1, "gap_percentage": 0.0},
                        {"indicator": "HIV Negative High-Risk Pregnant/Postpartum Women not Enrolled on PrEP", "gap": 0, "eligible": 0, "gap_percentage": 0.0},
                        {"indicator": "Virally Unsuppressed Clients Without EAC Within 2 Weeks", "gap": 0, "eligible": 0, "gap_percentage": 0.0},
                        {"indicator": "Delayed Viral Load Testing", "gap": 9, "eligible": 13, "gap_percentage": 69.23076923076923},
                        {"indicator": "HEI (6-8 Weeks) Without DNA PCR Results", "gap": 0, "eligible": 0, "gap_percentage": 0.0},
                        {"indicator": "HEI (24 Months) Without Final Documented Outcome", "gap": 0, "eligible": 0, "gap_percentage": 0.0}
                    ]
                },
                {
                    "site": "St. Lukes (ACK)",
                    "indicators": [
                        {"indicator": "HIV +ve Clients Not Linked to ART", "gap": 0, "eligible": 3, "gap_percentage": 0.0},
                        {"indicator": "HIV Negative High-Risk Pregnant/Postpartum Women not Enrolled on PrEP", "gap": 0, "eligible": 0, "gap_percentage": 0.0},
                        {"indicator": "Virally Unsuppressed Clients Without EAC Within 2 Weeks", "gap": 0, "eligible": 0, "gap_percentage": 0.0},
                        {"indicator": "Delayed Viral Load Testing", "gap": 38, "eligible": 41, "gap_percentage": 92.6829268292683},
                        {"indicator": "HEI (6-8 Weeks) Without DNA PCR Results", "gap": 0, "eligible": 0, "gap_percentage": 0.0},
                        {"indicator": "HEI (24 Months) Without Final Documented Outcome", "gap": 0, "eligible": 0, "gap_percentage": 0.0}
                    ]
                },
                {
                    "site": "St. Joseph Bura",
                    "indicators": [
                        {"indicator": "HIV +ve Clients Not Linked to ART", "gap": 0, "eligible": 0, "gap_percentage": 0.0},
                        {"indicator": "HIV Negative High-Risk Pregnant/Postpartum Women not Enrolled on PrEP", "gap": 0, "eligible": 0, "gap_percentage": 0.0},
                        {"indicator": "Virally Unsuppressed Clients Without EAC Within 2 Weeks", "gap": 0, "eligible": 0, "gap_percentage": 0.0},
                        {"indicator": "Delayed Viral Load Testing", "gap": 0, "eligible": 0, "gap_percentage": 0.0},
                        {"indicator": "HEI (6-8 Weeks) Without DNA PCR Results", "gap": 0, "eligible": 0, "gap_percentage": 0.0},
                        {"indicator": "HEI (24 Months) Without Final Documented Outcome", "gap": 0, "eligible": 0, "gap_percentage": 0.0}
                    ]
                },
                {
                    "site": "St. Joseph Maungu",
                    "indicators": [
                        {"indicator": "HIV +ve Clients Not Linked to ART", "gap": 0, "eligible": 0, "gap_percentage": 0.0},
                        {"indicator": "HIV Negative High-Risk Pregnant/Postpartum Women not Enrolled on PrEP", "gap": 0, "eligible": 0, "gap_percentage": 0.0},
                        {"indicator": "Virally Unsuppressed Clients Without EAC Within 2 Weeks", "gap": 0, "eligible": 0, "gap_percentage": 0.0},
                        {"indicator": "Delayed Viral Load Testing", "gap": 0, "eligible": 0, "gap_percentage": 0.0},
                        {"indicator": "HEI (6-8 Weeks) Without DNA PCR Results", "gap": 0, "eligible": 0, "gap_percentage": 0.0},
                        {"indicator": "HEI (24 Months) Without Final Documented Outcome", "gap": 0, "eligible": 0, "gap_percentage": 0.0}
                    ]
                },
                {
                    "site": "St. Joseph Shelter",
                    "indicators": [
                        {"indicator": "HIV +ve Clients Not Linked to ART", "gap": 0, "eligible": 0, "gap_percentage": 0.0},
                        {"indicator": "HIV Negative High-Risk Pregnant/Postpartum Women not Enrolled on PrEP", "gap": 1, "eligible": 1, "gap_percentage": 100.0},
                        {"indicator": "Virally Unsuppressed Clients Without EAC Within 2 Weeks", "gap": 0, "eligible": 0, "gap_percentage": 0.0},
                        {"indicator": "Delayed Viral Load Testing", "gap": 8, "eligible": 8, "gap_percentage": 100.0},
                        {"indicator": "HEI (6-8 Weeks) Without DNA PCR Results", "gap": 0, "eligible": 0, "gap_percentage": 0.0},
                        {"indicator": "HEI (24 Months) Without Final Documented Outcome", "gap": 0, "eligible": 0, "gap_percentage": 0.0}
                    ]
                }
            ],
            "reporting_data": [
                {"site": "Overall", "expected_uploads": 14, "overall_reporting_rate": 13, "overall_consistency_rate": 8, "reporting_rate_percentage": 92.85714285714286, "consistency_rate_percentage": 57.14285714285714},
                {"site": "Bomu Alwalidayn", "expected_uploads": 7, "overall_reporting_rate": 3, "overall_consistency_rate": 0, "reporting_rate_percentage": 42.857142857142854, "consistency_rate_percentage": 0.0},
                {"site": "Bomu Likoni", "expected_uploads": 7, "overall_reporting_rate": 7, "overall_consistency_rate": 7, "reporting_rate_percentage": 100.0, "consistency_rate_percentage": 100.0},
                {"site": "Bomu Changamwe", "expected_uploads": 7, "overall_reporting_rate": 7, "overall_consistency_rate": 7, "reporting_rate_percentage": 100.0, "consistency_rate_percentage": 100.0},
                {"site": "Bomu OldTown", "expected_uploads": 7, "overall_reporting_rate": 2, "overall_consistency_rate": 0, "reporting_rate_percentage": 28.57142857142857, "consistency_rate_percentage": 0.0},
                {"site": "Bomu Bombolulu", "expected_uploads": 7, "overall_reporting_rate": 6, "overall_consistency_rate": 1, "reporting_rate_percentage": 85.71428571428571, "consistency_rate_percentage": 14.285714285714285},
                {"site": "Bomu Mariakani", "expected_uploads": 7, "overall_reporting_rate": 7, "overall_consistency_rate": 7, "reporting_rate_percentage": 100.0, "consistency_rate_percentage": 100.0},
                {"site": "Bomu Timboni", "expected_uploads": 7, "overall_reporting_rate": 3, "overall_consistency_rate": 0, "reporting_rate_percentage": 42.857142857142854, "consistency_rate_percentage": 0.0},
                {"site": "CBHC Chaani", "expected_uploads": 7, "overall_reporting_rate": 6, "overall_consistency_rate": 0, "reporting_rate_percentage": 85.71428571428571, "consistency_rate_percentage": 0.0},
                {"site": "CBHC Mbungoni", "expected_uploads": 7, "overall_reporting_rate": 6, "overall_consistency_rate": 4, "reporting_rate_percentage": 85.71428571428571, "consistency_rate_percentage": 57.14285714285714},
                {"site": "CBHC Mikindani", "expected_uploads": 7, "overall_reporting_rate": 4, "overall_consistency_rate": 0, "reporting_rate_percentage": 57.14285714285714, "consistency_rate_percentage": 0.0},
                {"site": "St. Lukes (ACK)", "expected_uploads": 7, "overall_reporting_rate": 6, "overall_consistency_rate": 4, "reporting_rate_percentage": 85.71428571428571, "consistency_rate_percentage": 57.14285714285714},
                {"site": "St. Joseph Bura", "expected_uploads": 7, "overall_reporting_rate": 6, "overall_consistency_rate": 7, "reporting_rate_percentage": 85.71428571428571, "consistency_rate_percentage": 100.0},
                {"site": "St. Joseph Maungu", "expected_uploads": 7, "overall_reporting_rate": 0, "overall_consistency_rate": 0, "reporting_rate_percentage": 0.0, "consistency_rate_percentage": 0.0},
                {"site": "St. Joseph Shelter", "expected_uploads": 7, "overall_reporting_rate": 7, "overall_consistency_rate": 4, "reporting_rate_percentage": 100.0, "consistency_rate_percentage": 57.14285714285714}
            ]
        };
        
        // ======================
        // GLOBAL VARIABLES
        // ======================
        
        let dashboardData = {
            gap_data: [],
            reporting_data: [],
            metadata: {}
        };
        
        let uploadedFiles = {};
        
        // ======================
        // INITIALIZATION
        // ======================
        
        document.addEventListener('DOMContentLoaded', function() {
            // Show quick start section initially
            document.getElementById('quickStartSection').style.display = 'block';
            document.getElementById('uploadSection').style.display = 'none';
            document.getElementById('dashboardSection').style.display = 'none';
            
            // Update period display
            document.getElementById('periodDisplay').textContent = `Period: ${REAL_DATA.metadata.period}`;
        });
        
        // ======================
        // MAIN FUNCTIONS
        // ======================
        
        function loadRealData() {
            showLoader('Loading dashboard with real data...');
            
            // Use the embedded real data
            dashboardData = {
                gap_data: REAL_DATA.gap_data,
                reporting_data: REAL_DATA.reporting_data,
                metadata: {
                    period: REAL_DATA.metadata.period,
                    generated: new Date().toISOString(),
                    note: "Actual CBS data loaded"
                }
            };
            
            // Generate dashboard
            generateDashboard();
            
            // Show dashboard and hide others
            document.getElementById('dashboardSection').style.display = 'block';
            document.getElementById('quickStartSection').style.display = 'none';
            document.getElementById('uploadSection').style.display = 'none';
            
            // Scroll to dashboard
            setTimeout(() => {
                document.getElementById('dashboardSection').scrollIntoView({ behavior: 'smooth' });
                hideLoader();
            }, 500);
        }
        
        function showDashboard() {
            document.getElementById('dashboardSection').style.display = 'block';
            document.getElementById('quickStartSection').style.display = 'none';
            document.getElementById('uploadSection').style.display = 'none';
        }
        
        function showUploadSection() {
            document.getElementById('uploadSection').style.display = 'block';
            document.getElementById('dashboardSection').style.display = 'none';
            document.getElementById('quickStartSection').style.display = 'none';
            window.scrollTo(0, 0);
        }
        
        // ======================
        // DASHBOARD FUNCTIONS
        // ======================
        
        function generateDashboard() {
            createKPIOverview();
            createReportingRateChart();
            createConsistencyChart();
            createGapDistributionChart();
            createGapAnalysisByIndicator();
            createGapSummary();
        }
        
        function createKPIOverview() {
            const kpiSection = document.getElementById('kpiSection');
            const overallData = dashboardData.reporting_data.find(d => d.site === 'Overall') || dashboardData.reporting_data[0];
            
            let totalGaps = 0;
            let totalEligible = 0;
            
            dashboardData.gap_data.forEach(site => {
                if (site.site !== 'Overall') {
                    site.indicators.forEach(indicator => {
                        totalGaps += indicator.gap;
                        totalEligible += indicator.eligible;
                    });
                }
            });
            
            const gapPercentage = totalEligible > 0 ? ((totalGaps / totalEligible) * 100).toFixed(1) : 0;
            const activeSites = dashboardData.reporting_data.filter(d => d.site !== 'Overall').length;
            
            const kpiHTML = `
                <div class="kpi-card">
                    <div class="kpi-value" style="color: var(--success)">
                        ${overallData ? overallData.reporting_rate_percentage.toFixed(1) + '%' : 'N/A'}
                    </div>
                    <div class="kpi-label">OVERALL REPORTING RATE</div>
                    <div class="kpi-subtext">
                        ${overallData ? overallData.overall_reporting_rate + '/' + overallData.expected_uploads + ' reports' : ''}
                    </div>
                </div>
                
                <div class="kpi-card">
                    <div class="kpi-value" style="color: var(--secondary)">
                        ${overallData ? overallData.consistency_rate_percentage.toFixed(1) + '%' : 'N/A'}
                    </div>
                    <div class="kpi-label">OVERALL CONSISTENCY RATE</div>
                    <div class="kpi-subtext">Average across all sites</div>
                </div>
                
                <div class="kpi-card">
                    <div class="kpi-value" style="color: var(--warning)">${totalGaps}/${totalEligible}</div>
                    <div class="kpi-label">TOTAL GAPS IDENTIFIED</div>
                    <div class="kpi-subtext">${gapPercentage}% of eligible cases</div>
                </div>
                
                <div class="kpi-card">
                    <div class="kpi-value" style="color: var(--danger)">${activeSites}</div>
                    <div class="kpi-label">ACTIVE SITES</div>
                    <div class="kpi-subtext">Currently reporting</div>
                </div>
            `;
            
            kpiSection.innerHTML = kpiHTML;
        }
        
        function createReportingRateChart() {
            const sortedData = dashboardData.reporting_data
                .filter(d => d.site !== 'Overall')
                .sort((a, b) => b.reporting_rate_percentage - a.reporting_rate_percentage);
            
            const sites = sortedData.map(d => d.site);
            const reportingRates = sortedData.map(d => d.reporting_rate_percentage);
            const expected = sortedData.map(d => d.expected_uploads);
            const reported = sortedData.map(d => d.overall_reporting_rate);
            
            const hoverText = sites.map((site, i) => 
                `<b>${site}</b><br>` +
                `Reporting Rate: ${reportingRates[i].toFixed(1)}%<br>` +
                `Reports: ${reported[i]}/${expected[i]}<br>` +
                `Status: ${reportingRates[i] >= 80 ? 'Good' : reportingRates[i] >= 50 ? 'Fair' : 'Needs Attention'}`
            );
            
            const trace = {
                x: sites,
                y: reportingRates,
                type: 'bar',
                marker: {
                    color: reportingRates.map(rate => 
                        rate >= 80 ? '#27ae60' : 
                        rate >= 50 ? '#f39c12' : '#e74c3c'
                    )
                },
                text: reportingRates.map(rate => rate.toFixed(1) + '%'),
                textposition: 'outside',
                hovertext: hoverText,
                hoverinfo: 'text'
            };
            
            const layout = {
                title: {
                    text: 'Reporting Rate by Site (Descending Order)',
                    font: { size: 18 }
                },
                yaxis: {
                    title: {
                        text: 'Reporting Rate (%)',
                        font: { size: 14 }
                    },
                    range: [0, 105],
                    gridcolor: '#ecf0f1',
                    tickformat: ',.0f'
                },
                xaxis: {
                    title: {
                        text: 'Site',
                        font: { size: 14 }
                    },
                    tickangle: -45,
                    gridcolor: '#ecf0f1',
                    tickfont: { size: 12 }
                },
                plot_bgcolor: '#f8f9fa',
                paper_bgcolor: '#f8f9fa',
                showlegend: false,
                displayModeBar: false,
                margin: { t: 60, r: 40, b: 150, l: 80 },
                height: 500
            };
            
            Plotly.newPlot('reportingRateChart', [trace], layout, {displayModeBar: false});
        }
        
        function createConsistencyChart() {
            const sortedData = dashboardData.reporting_data
                .filter(d => d.site !== 'Overall')
                .sort((a, b) => b.consistency_rate_percentage - a.consistency_rate_percentage);
            
            const sites = sortedData.map(d => d.site);
            const consistencyRates = sortedData.map(d => d.consistency_rate_percentage);
            const expected = sortedData.map(d => d.expected_uploads);
            const consistent = sortedData.map(d => d.overall_consistency_rate);
            
            const hoverText = sites.map((site, i) => 
                `<b>${site}</b><br>` +
                `Consistency Rate: ${consistencyRates[i].toFixed(1)}%<br>` +
                `Consistent Reports: ${consistent[i]}/${expected[i]}<br>` +
                `Status: ${consistencyRates[i] >= 80 ? 'Good' : consistencyRates[i] >= 50 ? 'Fair' : 'Needs Attention'}`
            );
            
            const trace = {
                x: sites,
                y: consistencyRates,
                type: 'bar',
                marker: {
                    color: consistencyRates.map(rate => 
                        rate >= 80 ? '#27ae60' : 
                        rate >= 50 ? '#f39c12' : '#e74c3c'
                    )
                },
                text: consistencyRates.map(rate => rate.toFixed(1) + '%'),
                textposition: 'outside',
                hovertext: hoverText,
                hoverinfo: 'text'
            };
            
            const layout = {
                title: {
                    text: 'Consistency Rate by Site (Descending Order)',
                    font: { size: 18 }
                },
                yaxis: {
                    title: {
                        text: 'Consistency Rate (%)',
                        font: { size: 14 }
                    },
                    range: [0, 105],
                    gridcolor: '#ecf0f1',
                    tickformat: ',.0f'
                },
                xaxis: {
                    title: {
                        text: 'Site',
                        font: { size: 14 }
                    },
                    tickangle: -45,
                    gridcolor: '#ecf0f1',
                    tickfont: { size: 12 }
                },
                plot_bgcolor: '#f8f9fa',
                paper_bgcolor: '#f8f9fa',
                showlegend: false,
                displayModeBar: false,
                margin: { t: 60, r: 40, b: 150, l: 80 },
                height: 500
            };
            
            Plotly.newPlot('consistencyChart', [trace], layout, {displayModeBar: false});
        }
        
        function createGapDistributionChart() {
            const facilityGapData = [];
            
            dashboardData.gap_data.forEach(site => {
                if (site.site !== 'Overall') {
                    let totalGaps = 0;
                    let totalEligible = 0;
                    
                    site.indicators.forEach(indicator => {
                        totalGaps += indicator.gap;
                        totalEligible += indicator.eligible;
                    });
                    
                    const gapPercentage = totalEligible > 0 ? ((totalGaps / totalEligible) * 100).toFixed(1) : 0;
                    
                    facilityGapData.push({
                        site: site.site,
                        totalGaps: totalGaps,
                        totalEligible: totalEligible,
                        gapPercentage: parseFloat(gapPercentage),
                        displayText: `${site.site} ${gapPercentage}% (${totalGaps}/${totalEligible})`
                    });
                }
            });
            
            facilityGapData.sort((a, b) => b.gapPercentage - a.gapPercentage);
            
            const sites = facilityGapData.map(d => d.displayText);
            const gapPercentages = facilityGapData.map(d => d.gapPercentage);
            const totalGaps = facilityGapData.map(d => d.totalGaps);
            const totalEligible = facilityGapData.map(d => d.totalEligible);
            
            const hoverText = sites.map((site, i) => 
                `<b>${facilityGapData[i].site}</b><br>` +
                `Overall Gap Percentage: ${gapPercentages[i]}%<br>` +
                `Total Gaps: ${totalGaps[i]}/${totalEligible[i]}<br>` +
                `Rank: #${i + 1}`
            );
            
            const trace = {
                x: sites,
                y: gapPercentages,
                type: 'bar',
                marker: {
                    color: gapPercentages.map(percentage => {
                        if (percentage >= 70) return '#e74c3c';
                        if (percentage >= 50) return '#f39c12';
                        if (percentage >= 30) return '#f1c40f';
                        return '#27ae60';
                    }),
                    line: {
                        color: 'rgba(0,0,0,0.2)',
                        width: 1
                    }
                },
                text: gapPercentages.map(p => p + '%'),
                textposition: 'outside',
                hovertext: hoverText,
                hoverinfo: 'text'
            };
            
            const layout = {
                title: {
                    text: 'Gap Distribution by Facility (Ranked Highest to Lowest)',
                    font: { size: 18 }
                },
                yaxis: {
                    title: {
                        text: 'Overall Gap Percentage (%)',
                        font: { size: 14 }
                    },
                    range: [0, 105],
                    gridcolor: '#ecf0f1',
                    tickformat: ',.0f'
                },
                xaxis: {
                    title: {
                        text: 'Facility (Gap Percentage - Gaps/Eligible)',
                        font: { size: 14 }
                    },
                    tickangle: -45,
                    gridcolor: '#ecf0f1',
                    tickfont: { size: 12 }
                },
                plot_bgcolor: '#f8f9fa',
                paper_bgcolor: '#f8f9fa',
                showlegend: false,
                displayModeBar: false,
                margin: { t: 60, r: 40, b: 200, l: 80 },
                height: 500
            };
            
            Plotly.newPlot('gapDistributionChart', [trace], layout, {displayModeBar: false});
        }
        
        function createGapAnalysisByIndicator() {
            const delayedVLContainer = document.getElementById('delayedVLChartContainer');
            const otherGapsGrid = document.getElementById('otherGapsGrid');
            
            const indicators = [
                { 
                    fullName: "Delayed Viral Load Testing",
                    shortName: "Delayed VL",
                    color: '#e67e22',
                    index: 3,
                    priority: 1
                },
                { 
                    fullName: "HEI (24 Months) Without Final Documented Outcome",
                    shortName: "HEI No Outcome",
                    color: '#c0392b',
                    index: 5,
                    priority: 0
                },
                { 
                    fullName: "HIV +ve Clients Not Linked to ART",
                    shortName: "HIV+ Not Linked",
                    color: '#e74c3c',
                    index: 0,
                    priority: 0
                },
                { 
                    fullName: "HIV Negative High-Risk Pregnant/Postpartum Women not Enrolled on PrEP",
                    shortName: "High-Risk No PrEP",
                    color: '#f39c12',
                    index: 1,
                    priority: 0
                },
                { 
                    fullName: "Virally Unsuppressed Clients Without EAC Within 2 Weeks",
                    shortName: "Unsuppressed No EAC",
                    color: '#f1c40f',
                    index: 2,
                    priority: 0
                },
                { 
                    fullName: "HEI (6-8 Weeks) Without DNA PCR Results",
                    shortName: "HEI No DNA PCR",
                    color: '#d35400',
                    index: 4,
                    priority: 0
                }
            ];
            
            delayedVLContainer.innerHTML = '';
            otherGapsGrid.innerHTML = '';
            
            indicators.forEach((indicator, indicatorIdx) => {
                const sitesWithGaps = [];
                
                dashboardData.gap_data.forEach(site => {
                    if (site.site !== 'Overall' && site.indicators[indicator.index]) {
                        const gapData = site.indicators[indicator.index];
                        if (gapData.gap > 0) {
                            sitesWithGaps.push({
                                site: site.site,
                                gap: gapData.gap,
                                eligible: gapData.eligible,
                                percentage: gapData.gap_percentage
                            });
                        }
                    }
                });
                
                sitesWithGaps.sort((a, b) => b.gap - a.gap);
                
                if (sitesWithGaps.length > 0) {
                    const siteNames = sitesWithGaps.map(d => d.site);
                    const gaps = sitesWithGaps.map(d => d.gap);
                    const percentages = sitesWithGaps.map(d => d.percentage);
                    
                    const totalGaps = gaps.reduce((a, b) => a + b, 0);
                    const totalEligible = sitesWithGaps.reduce((sum, d) => sum + d.eligible, 0);
                    const overallPercentage = totalEligible > 0 ? ((totalGaps / totalEligible) * 100).toFixed(1) : 0;
                    
                    const chartId = `gapChart${indicator.index}`;
                    
                    if (indicator.priority === 1) {
                        delayedVLContainer.innerHTML = `
                            <div class="gap-indicator-card" style="border-left: 4px solid ${indicator.color};">
                                <div class="gap-indicator-title">
                                    ${indicator.shortName} - ${totalGaps} gaps (${overallPercentage}% of ${totalEligible} eligible)
                                </div>
                                <div id="${chartId}" class="chart-container"></div>
                            </div>
                        `;
                        
                        setTimeout(() => {
                            createFullWidthGapChart(chartId, indicator.shortName, siteNames, gaps, percentages, indicator.color, totalGaps, overallPercentage, totalEligible);
                        }, 100);
                    } else {
                        const gapCard = document.createElement('div');
                        gapCard.className = 'gap-indicator-card';
                        gapCard.style.borderLeft = `4px solid ${indicator.color}`;
                        gapCard.innerHTML = `
                            <div class="gap-indicator-title">
                                ${indicator.shortName} - ${totalGaps} gaps (${overallPercentage}% of ${totalEligible} eligible)
                            </div>
                            <div id="${chartId}" class="gap-chart-container"></div>
                        `;
                        otherGapsGrid.appendChild(gapCard);
                        
                        setTimeout(() => {
                            createSmallGapChart(chartId, indicator.shortName, siteNames, gaps, percentages, indicator.color);
                        }, 100 + (indicatorIdx * 50));
                    }
                }
            });
        }
        
        function createFullWidthGapChart(containerId, indicatorName, sites, gaps, percentages, color, totalGaps, overallPercentage, totalEligible) {
            const hoverText = sites.map((site, i) => 
                `<b>${site}</b><br>` +
                `Gaps: ${gaps[i]}<br>` +
                `Percentage: ${percentages[i].toFixed(1)}%<br>` +
                `Impact: ${gaps[i] > 50 ? 'Critical' : gaps[i] > 20 ? 'High' : gaps[i] > 5 ? 'Medium' : 'Low'}`
            );
            
            const trace = {
                x: sites,
                y: gaps,
                type: 'bar',
                marker: {
                    color: color,
                    line: {
                        color: 'rgba(0,0,0,0.2)',
                        width: 1
                    }
                },
                text: gaps.map((gap, i) => `${gap} (${percentages[i].toFixed(1)}%)`),
                textposition: 'outside',
                hovertext: hoverText,
                hoverinfo: 'text'
            };
            
            const layout = {
                title: {
                    text: `${indicatorName} - ${totalGaps} Gaps (${overallPercentage}% of ${totalEligible} Eligible)`,
                    font: { size: 18 }
                },
                yaxis: {
                    title: {
                        text: 'Number of Gaps',
                        font: { size: 14 }
                    },
                    gridcolor: '#ecf0f1'
                },
                xaxis: {
                    title: {
                        text: 'Facility',
                        font: { size: 14 }
                    },
                    tickangle: -45,
                    gridcolor: '#ecf0f1',
                    tickfont: { size: 12 }
                },
                plot_bgcolor: '#f8f9fa',
                paper_bgcolor: '#f8f9fa',
                showlegend: false,
                displayModeBar: false,
                margin: { t: 60, r: 40, b: 150, l: 80 },
                height: 500
            };
            
            Plotly.newPlot(containerId, [trace], layout, {displayModeBar: false});
        }
        
        function createSmallGapChart(containerId, indicatorName, sites, gaps, percentages, color) {
            const hoverText = sites.map((site, i) => 
                `<b>${site}</b><br>` +
                `Gaps: ${gaps[i]}<br>` +
                `Percentage: ${percentages[i].toFixed(1)}%<br>` +
                `Impact: ${gaps[i] > 10 ? 'High' : gaps[i] > 5 ? 'Medium' : 'Low'}`
            );
            
            const trace = {
                x: sites,
                y: gaps,
                type: 'bar',
                marker: {
                    color: color,
                    line: {
                        color: 'rgba(0,0,0,0.2)',
                        width: 1
                    }
                },
                text: gaps.map((gap, i) => `${gap} (${percentages[i].toFixed(1)}%)`),
                textposition: 'outside',
                hovertext: hoverText,
                hoverinfo: 'text'
            };
            
            const layout = {
                title: {
                    text: `Facilities with ${indicatorName} Gaps`,
                    font: { size: 16 }
                },
                yaxis: {
                    title: {
                        text: 'Number of Gaps',
                        font: { size: 12 }
                    },
                    gridcolor: '#ecf0f1'
                },
                xaxis: {
                    title: {
                        text: 'Facility',
                        font: { size: 12 }
                    },
                    tickangle: -45,
                    gridcolor: '#ecf0f1',
                    tickfont: { size: 10 }
                },
                plot_bgcolor: '#f8f9fa',
                paper_bgcolor: '#f8f9fa',
                showlegend: false,
                displayModeBar: false,
                margin: { t: 50, r: 30, b: 120, l: 60 },
                height: 350
            };
            
            Plotly.newPlot(containerId, [trace], layout, {displayModeBar: false});
        }
        
        function createGapSummary() {
            const gapSummary = document.getElementById('gapSummary');
            
            let totalGaps = 0;
            let totalEligible = 0;
            let sitesWithAnyGaps = 0;
            
            const siteGapData = {};
            
            dashboardData.gap_data.forEach(site => {
                if (site.site !== 'Overall') {
                    let siteTotalGaps = 0;
                    let siteTotalEligible = 0;
                    
                    site.indicators.forEach(indicator => {
                        siteTotalGaps += indicator.gap;
                        siteTotalEligible += indicator.eligible;
                    });
                    
                    totalGaps += siteTotalGaps;
                    totalEligible += siteTotalEligible;
                    
                    siteGapData[site.site] = {
                        gaps: siteTotalGaps,
                        eligible: siteTotalEligible,
                        percentage: siteTotalEligible > 0 ? (siteTotalGaps / siteTotalEligible * 100).toFixed(1) : 0
                    };
                    
                    if (siteTotalGaps > 0) {
                        sitesWithAnyGaps++;
                    }
                }
            });
            
            const overallPercentage = totalEligible > 0 ? (totalGaps / totalEligible * 100).toFixed(1) : 0;
            
            const sortedSites = Object.entries(siteGapData)
                .sort(([, a], [, b]) => b.gaps - a.gaps)
                .slice(0, 3);
            
            const reportingSites = dashboardData.reporting_data.filter(d => d.site !== 'Overall');
            const sitesBelow80Reporting = reportingSites.filter(d => d.reporting_rate_percentage < 80).length;
            const sitesBelow50Reporting = reportingSites.filter(d => d.reporting_rate_percentage < 50).length;
            const sitesBelow80Consistency = reportingSites.filter(d => d.consistency_rate_percentage < 80).length;
            const sitesBelow50Consistency = reportingSites.filter(d => d.consistency_rate_percentage < 50).length;
            
            const summaryHTML = `
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px; margin-bottom: 20px;">
                    <div style="background: rgba(231, 76, 60, 0.1); padding: 15px; border-radius: 10px; border-left: 4px solid var(--danger);">
                        <div style="font-size: 24px; font-weight: bold; color: var(--danger);">${totalGaps}/${totalEligible}</div>
                        <div style="color: var(--dark); font-size: 14px;">Total Gaps (${overallPercentage}% of eligible)</div>
                    </div>
                    
                    <div style="background: rgba(243, 156, 18, 0.1); padding: 15px; border-radius: 10px; border-left: 4px solid var(--warning);">
                        <div style="font-size: 24px; font-weight: bold; color: var(--warning);">${sitesWithAnyGaps}</div>
                        <div style="color: var(--dark); font-size: 14px;">Sites with Gaps</div>
                    </div>
                    
                    <div style="background: rgba(52, 152, 219, 0.1); padding: 15px; border-radius: 10px; border-left: 4px solid var(--secondary);">
                        <div style="font-size: 24px; font-weight: bold; color: var(--secondary);">${sitesBelow80Reporting}</div>
                        <div style="color: var(--dark); font-size: 14px;">Sites with Reporting Rate < 80%</div>
                    </div>
                    
                    <div style="background: rgba(39, 174, 96, 0.1); padding: 15px; border-radius: 10px; border-left: 4px solid var(--success);">
                        <div style="font-size: 24px; font-weight: bold; color: var(--success);">${sitesBelow80Consistency}</div>
                        <div style="color: var(--dark); font-size: 14px;">Sites with Consistency < 80%</div>
                    </div>
                </div>
                
                <div style="margin-top: 20px;">
                    <p style="color: var(--dark); line-height: 1.6;">
                        <strong>Key Findings:</strong> ${sitesWithAnyGaps} out of ${reportingSites.length} sites have identified gaps. 
                        The top 3 sites contributing to gaps are: 
                        ${sortedSites.map(([site, data]) => `<strong>${site}</strong> (${data.gaps} gaps, ${data.percentage}%)`).join(', ')}.
                    </p>
                    
                    <p style="color: var(--dark); line-height: 1.6; margin-top: 10px;">
                        <strong>Reporting Rate Concern:</strong> ${sitesBelow80Reporting} sites have reporting rates below 80%, 
                        with ${sitesBelow50Reporting} sites critically low (<50%). 
                        <strong>Consistency Issue:</strong> ${sitesBelow80Consistency} sites have consistency rates below 80%, 
                        with ${sitesBelow50Consistency} sites critically low (<50%).
                    </p>
                </div>
            `;
            
            gapSummary.innerHTML = summaryHTML;
        }
        
        // ======================
        // FILE UPLOAD FUNCTIONS
        // ======================
        
        document.getElementById('fileInput').addEventListener('change', handleFileSelect);
        
        function handleFileSelect(event) {
            const files = event.target.files;
            const fileList = document.getElementById('fileList');
            fileList.innerHTML = '';
            
            for (let file of files) {
                if (file.name.includes('.xlsx') || file.name.includes('.xls')) {
                    uploadedFiles[file.name] = file;
                    addFileToList(file);
                }
            }
            
            updateGenerateButton();
        }
        
        function addFileToList(file) {
            const fileList = document.getElementById('fileList');
            const fileItem = document.createElement('div');
            fileItem.className = 'file-item';
            fileItem.innerHTML = `
                <div style="display: flex; align-items: center; gap: 10px;">
                    <span>üìÑ</span>
                    <span style="font-weight: 600; color: var(--primary);">${file.name}</span>
                </div>
                <div style="color: var(--warning); font-size: 14px;">Pending</div>
            `;
            fileList.appendChild(fileItem);
        }
        
        function updateGenerateButton() {
            const hasGapFile = Object.keys(uploadedFiles).some(name => 
                name.toLowerCase().includes('gap') || name.toLowerCase().includes('weekly_gap')
            );
            const hasReportFile = Object.keys(uploadedFiles).some(name => 
                name.toLowerCase().includes('rr') || name.toLowerCase().includes('weekly_rr') || name.toLowerCase().includes('reporting')
            );
            
            const generateBtn = document.getElementById('generateBtn');
            const errorAlert = document.getElementById('errorAlert');
            const successAlert = document.getElementById('successAlert');
            
            if (hasGapFile && hasReportFile) {
                generateBtn.disabled = false;
                errorAlert.style.display = 'none';
                successAlert.style.display = 'flex';
            } else {
                generateBtn.disabled = true;
                errorAlert.style.display = 'flex';
                successAlert.style.display = 'none';
            }
        }
        
        async function processUploadedFiles() {
            showLoader('Processing Excel files...');
            
            try {
                let gapFile, reportFile;
                
                for (const [name, file] of Object.entries(uploadedFiles)) {
                    if (name.toLowerCase().includes('gap') || name.toLowerCase().includes('weekly_gap')) {
                        gapFile = file;
                    } else if (name.toLowerCase().includes('rr') || name.toLowerCase().includes('weekly_rr') || name.toLowerCase().includes('reporting')) {
                        reportFile = file;
                    }
                }
                
                if (!gapFile || !reportFile) {
                    throw new Error('Required files not found');
                }
                
                const gapData = await processExcelFile(gapFile, 'gap');
                const reportData = await processExcelFile(reportFile, 'report');
                
                dashboardData = {
                    gap_data: gapData,
                    reporting_data: reportData,
                    metadata: {
                        period: "24th - 28th Nov 2025",
                        generated: new Date().toISOString(),
                        files: Object.keys(uploadedFiles)
                    }
                };
                
                generateDashboard();
                showDashboard();
                
                const fileItems = document.querySelectorAll('.file-item');
                fileItems.forEach(item => {
                    item.querySelector('div:last-child').textContent = '‚úì Processed';
                    item.querySelector('div:last-child').style.color = 'var(--success)';
                });
                
            } catch (error) {
                console.error('Error processing files:', error);
                alert(`Error: ${error.message}\n\nPlease make sure you uploaded the correct Excel files.`);
                
                const fileItems = document.querySelectorAll('.file-item');
                fileItems.forEach(item => {
                    item.querySelector('div:last-child').textContent = '‚úó Error';
                    item.querySelector('div:last-child').style.color = 'var(--danger)';
                });
            } finally {
                hideLoader();
            }
        }
        
        async function processExcelFile(file, type) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                
                reader.onload = function(e) {
                    try {
                        const data = new Uint8Array(e.target.result);
                        const workbook = XLSX.read(data, { type: 'array' });
                        const sheetName = workbook.SheetNames[0];
                        const worksheet = workbook.Sheets[sheetName];
                        
                        let jsonData;
                        if (type === 'gap') {
                            jsonData = processGapData(worksheet);
                        } else {
                            jsonData = processReportingData(worksheet);
                        }
                        
                        resolve(jsonData);
                    } catch (error) {
                        reject(error);
                    }
                };
                
                reader.onerror = reject;
                reader.readAsArrayBuffer(file);
            });
        }
        
        function processGapData(worksheet) {
            const jsonData = XLSX.utils.sheet_to_json(worksheet, { header: 1 });
            
            let headerRow = 0;
            for (let i = 0; i < Math.min(5, jsonData.length); i++) {
                if (jsonData[i] && jsonData[i][0] && jsonData[i][0].toString().includes('HIV')) {
                    headerRow = i;
                    break;
                }
            }
            
            const indicatorNames = [
                "HIV +ve Clients Not Linked to ART",
                "HIV Negative High-Risk Pregnant/Postpartum Women not Enrolled on PrEP",
                "Virally Unsuppressed Clients Without EAC Within 2 Weeks",
                "Delayed Viral Load Testing",
                "HEI (6-8 Weeks) Without DNA PCR Results",
                "HEI (24 Months) Without Final Documented Outcome"
            ];
            
            const structuredData = [];
            
            for (let i = headerRow + 2; i < jsonData.length; i++) {
                const row = jsonData[i];
                if (!row || !row[0]) continue;
                
                const site = row[0].toString().trim();
                if (!site) continue;
                
                const siteData = {
                    site: site,
                    indicators: []
                };
                
                for (let indicatorIdx = 0; indicatorIdx < 6; indicatorIdx++) {
                    const startCol = indicatorIdx * 3 + 1;
                    
                    if (startCol + 2 >= row.length) break;
                    
                    const gap = parseFloat(row[startCol]) || 0;
                    const eligible = parseFloat(row[startCol + 1]) || 0;
                    let gapPercentage = parseFloat(row[startCol + 2]) || 0;
                    
                    if (gapPercentage <= 1) {
                        gapPercentage = gapPercentage * 100;
                    }
                    
                    siteData.indicators.push({
                        indicator: indicatorNames[indicatorIdx],
                        gap: Math.round(gap),
                        eligible: Math.round(eligible),
                        gap_percentage: parseFloat(gapPercentage.toFixed(1))
                    });
                }
                
                structuredData.push(siteData);
            }
            
            return structuredData;
        }
        
        function processReportingData(worksheet) {
            const jsonData = XLSX.utils.sheet_to_json(worksheet, { header: 1 });
            
            let headerRow = 0;
            for (let i = 0; i < Math.min(5, jsonData.length); i++) {
                if (jsonData[i] && jsonData[i][0] && jsonData[i][0].toString().includes('Site')) {
                    headerRow = i;
                    break;
                }
            }
            
            const structuredData = [];
            
            for (let i = headerRow + 1; i < jsonData.length; i++) {
                const row = jsonData[i];
                if (!row || !row[0]) continue;
                
                const site = row[0].toString().trim();
                if (!site) continue;
                
                const expectedUploads = parseFloat(row[1]) || 0;
                const overallReporting = parseFloat(row[2]) || 0;
                const overallConsistency = parseFloat(row[3]) || 0;
                let reportingPercentage = parseFloat(row[4]) || 0;
                let consistencyPercentage = parseFloat(row[5]) || 0;
                
                if (reportingPercentage <= 1) {
                    reportingPercentage = reportingPercentage * 100;
                }
                if (consistencyPercentage <= 1) {
                    consistencyPercentage = consistencyPercentage * 100;
                }
                
                structuredData.push({
                    site: site,
                    expected_uploads: Math.round(expectedUploads),
                    overall_reporting_rate: Math.round(overallReporting),
                    overall_consistency_rate: Math.round(overallConsistency),
                    reporting_rate_percentage: parseFloat(reportingPercentage.toFixed(1)),
                    consistency_rate_percentage: parseFloat(consistencyPercentage.toFixed(1))
                });
            }
            
            return structuredData;
        }
        
        // ======================
        // UTILITY FUNCTIONS
        // ======================
        
        function exportDataToCSV() {
            if (!dashboardData.gap_data.length || !dashboardData.reporting_data.length) {
                alert('Please load data first');
                return;
            }
            
            let csvContent = "Mkomani Clinic CBS Dashboard Data\n\n";
            csvContent += "Generated: " + new Date().toLocaleString() + "\n";
            csvContent += "Period: " + dashboardData.metadata.period + "\n\n";
            
            csvContent += "REPORTING DATA\n";
            csvContent += "Site,Expected Uploads,Overall Reporting,Overall Consistency,Reporting %,Consistency %\n";
            dashboardData.reporting_data.forEach(row => {
                csvContent += `"${row.site}",${row.expected_uploads},${row.overall_reporting_rate},${row.overall_consistency_rate},${row.reporting_rate_percentage.toFixed(1)},${row.consistency_rate_percentage.toFixed(1)}\n`;
            });
            
            csvContent += "\nGAP ANALYSIS DATA\n";
            csvContent += "Site,Indicator,Gap Count,Eligible Count,Gap Percentage\n";
            dashboardData.gap_data.forEach(site => {
                site.indicators.forEach(indicator => {
                    csvContent += `"${site.site}","${indicator.indicator}",${indicator.gap},${indicator.eligible},${indicator.gap_percentage.toFixed(1)}\n`;
                });
            });
            
            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `CBS_Dashboard_Export_${new Date().toISOString().slice(0,10)}.csv`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }
        
        function printDashboard() {
            window.print();
        }
        
        function showLoader(text) {
            document.getElementById('loaderText').textContent = text;
            document.getElementById('loader').classList.add('active');
        }
        
        function hideLoader() {
            document.getElementById('loader').classList.remove('active');
        }
        
        // Auto-load dashboard after 1 second (optional)
        setTimeout(() => {
            // Uncomment the next line if you want dashboard to auto-load
            // loadRealData();
        }, 1000);
    </script>
</body>
</html>
